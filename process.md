# iflist02.py 프로세스 분석

## 프로그램 개요
이 프로그램은 SQLite 데이터베이스에서 특정 조건에 맞는 데이터를 추출하여 가공한 후 Excel 파일로 출력하는 작업을 수행합니다. 주요 기능은 'LY'와 'LZ' 문자열이 포함된 행을 찾아 관련 데이터를 재정렬하고, 특정 조건에 맞는 행을 노란색으로 표시하는 것입니다.

## 처리 프로세스

### 1. 초기 설정
- SQLite DB 파일명 (info.sqlite)과 테이블명 (list) 설정
- 대상 컬럼명 설정: '컬럼B', '컬럼C', '컬럼D'
- 검색 및 대체 문자열 정의:
  - 'LY'를 'LH'로 대체
  - 'LZ'를 'VO'로 대체
- 출력 Excel 파일명 설정: 스크립트 이름 + "_reordered_v2.xlsx" (버전 표시)

### 2. 데이터베이스에서 데이터 추출
- SQLite 데이터베이스에 연결
- **원본 전체 데이터 로드**: 테이블의 모든 행을 df_complete_table로 로드
- **초기 필터링 적용**: 컬럼B 또는 컬럼C에 'LY' 또는 'LZ'가 포함된 행만 df_filtered로 추출
- 문자열 변환 및 NaN 처리를 통한 안전한 필터링 로직 적용

### 3. 데이터 가공 및 재정렬
- 필수 컬럼 존재 여부 확인 (df_filtered와 df_complete_table 모두에서 확인)
- df_filtered의 각 행에 대해 다음 처리 수행:
  1. 원본 행을 output_rows_info 리스트에 추가 (노란색 표시 없음)
  2. 현재 행의 컬럼D 값과 동일한 값을 가진 다른 행들을 **원본 전체 테이블(df_complete_table)에서** 검색
  3. 추가 필터링 조건 적용:
     - 컬럼B에서 'LY'를 'LH'로 또는 'LZ'를 'VO'로 변환했을 때 다른 행의 컬럼B와 일치하는지 확인
     - 컬럼C에서 'LY'를 'LH'로 또는 'LZ'를 'VO'로 변환했을 때 다른 행의 컬럼C와 일치하는지 확인
  4. 조건을 만족하는 행을 output_rows_info에 추가하고 노란색 표시 플래그 설정

### 4. 최종 DataFrame 생성
- output_rows_info의 데이터를 기반으로 최종 DataFrame(df_excel_output) 생성
- 컬럼 순서 유지를 위해 원본 테이블의 컬럼 정보 활용
- 노란색으로 표시할 행의 인덱스 리스트 생성

### 5. Excel 파일 생성 및 스타일 적용
- xlsxwriter 엔진을 사용하여 Excel 파일 생성
- 'ProcessedData' 시트에 데이터 저장
- 조건에 맞는 행에 노란색 배경 적용
- 컬럼 너비 자동 조절 (가독성 향상)
- 결과 파일 저장

## 주요 조건 및 로직
1. **초기 필터링**: 컬럼B 또는 컬럼C에 'LY' 또는 'LZ'가 포함된 행 추출
2. **행 매칭 조건**:
   - 컬럼D 값이 동일(공백 제거 후)
   - 컬럼B에서 'LY'→'LH' 또는 'LZ'→'VO' 변환 후 일치
   - 또는 컬럼C에서 'LY'→'LH' 또는 'LZ'→'VO' 변환 후 일치
3. **출력 형식**: 원본 행 뒤에 매칭된 행을 배치하고, 매칭된 행은 노란색으로 표시

## 개선된 기능
1. **전체 데이터 활용**: 원본 전체 테이블(df_complete_table)을 로드하여 더 많은 데이터와 비교 가능
2. **안전한 데이터 처리**: 
   - 데이터프레임 복사본 생성으로 원본 데이터 보존
   - 문자열 변환 및 NaN 처리를 통한 안전한 필터링
3. **컬럼 순서 유지**: 원본 테이블의 컬럼 순서를 최종 결과물에도 적용
4. **상세한 오류 메시지**: 다양한 상황에 대한 구체적인 오류 메시지 제공

## 예외 처리
- 데이터베이스 연결 오류 처리
- 원본 테이블 데이터 없음 처리
- 필터링 결과 없음 처리
- 필수 컬럼 존재 여부 확인 (df_filtered와 df_complete_table 모두)
- Excel 파일 저장 시 예외 처리
- 필요 라이브러리(xlsxwriter) 미설치 시 안내 메시지 출력

---

# iflist03.py 개선사항 요약

## 버전 변경 내역

### v3.0: 다중 매칭 시 우선순위 적용 및 디버깅용 색상 구분
- 여러 매칭 행이 있을 때 우선순위 필터링 기능 추가:
  - 케이스 1: 송신시스템과 수신시스템 모두 매칭되는 행
  - 케이스 2: 송신시스템 값이 같은 행
  - 케이스 2-1: 수신시스템 값이 같은 행
- 가시성 향상을 위해 행 색상 구분:
  - 매칭된 모든 행: 노란색
  - 우선순위로 필터링된 최종 행: 연두색

### v4.0: 디버깅 모드 토글 기능
- `debug_mode` 변수 추가로 출력 제어:
  - `debug_mode = 0` 또는 `2`: 최종 필터링된 행(연두색)만 표시
  - `debug_mode = 1`: 모든 매칭 행(노란색)과 필터링된 행(연두색) 모두 표시
- 출력 메시지를 디버그 모드에 따라 다르게 설정

### v5.0: 송신/수신 파일 경로 정보 컬럼 추가
- 각 행에 송신 및 수신 파일 경로 정보를 계산하여 추가 컬럼으로 저장
- 파일 경로 생성 규칙 구현:
  - 기본 경로: `C:\BwProject\`
  - 디렉토리 구조: `1번 디렉토리\2번 디렉토리\Processes\3번 디렉토리\4번 디렉토리\5번디렉토리\파일명`
  - 법인 정보에 따른 1번 디렉토리 결정 (KR, CN, VN 및 TEST/PROD 접미사)
  - 패키지 이름 기반의 2번/5번 디렉토리
  - 업무명에 따른 조건부 3번 디렉토리
  - EMS명에 따른 4번 디렉토리
  - 그룹ID, 이벤트ID 등을 활용한 파일명 생성

### v6.0: 파일 존재 여부 확인 기능
- 생성된 파일 경로가 실제로 존재하는지 확인하는 기능 추가
- 파일 존재 여부를 새 컬럼('송신파일존재', '수신파일존재')에 저장
- Excel 출력 시 존재 여부에 따라 셀 색상 적용:
  - 파일이 존재하면 1(연두색)
  - 파일이 존재하지 않으면 0(주황색)

### v7.0: 디렉토리 파일 개수 확인 기능
- 파일이 위치한 디렉토리의 파일 개수를 세는 기능 추가
- 파일이 존재할 경우에만 디렉토리 파일 개수 계산
- 결과를 새 컬럼('송신DF', '수신DF')에 저장
- Excel 출력 시 파일 개수에 따라 차등 색상 적용:
  - 0개: 회색
  - 1-3개: 매우 밝은 파란색
  - 4-10개: 밝은 파란색
  - 11-20개: 중간 파란색
  - 21개 이상: 진한 파란색
- 디렉토리 파일 개수에 대한 통계 정보 출력 (총 파일 수, 디렉토리당 평균 파일 수)

## 구현된 주요 기능

### 디버그 모드 설정
```python
# 디버깅 모드 설정
# debug_mode = 0 또는 2: 최종 필터링된 행(연두색)만 표시
# debug_mode = 1: 모든 매칭 행(노란색)과 필터링된 행(연두색) 모두 표시
debug_mode = 1  # 기본값: 디버깅 모드 활성화
```

### 파일 경로 생성
```python
def create_file_path(row, is_send=True):
    # 행 데이터로부터 송신/수신 파일 경로 생성
    # 송신/수신 파라미터에 따라 다른 경로 계산
    # 컬럼값 누락 시 안전한 처리
    # ...
```

### 파일 존재 여부 확인
```python
def check_file_exists(file_path):
    # 파일 경로가 실제로 존재하는지 확인
    # 존재하면 1, 존재하지 않으면 0 반환
    # ...
```

### 디렉토리 파일 개수 계산
```python
def count_files_in_directory(file_path):
    # 파일이 위치한 디렉토리 내 파일 개수 반환
    # 디렉토리 내 파일만 카운트 (하위 디렉토리 제외)
    # ...
```

## 향후 고려사항
1. 파일 경로의 기본 경로(`C:\BwProject`)를 설정 파일이나 명령행 인수로 지정할 수 있는 기능 추가
2. 디렉토리 구조 및 파일명 생성 규칙을 더 유연하게 설정할 수 있도록 개선
3. 존재하지 않는 파일의 생성 기능 구현 (필요시)
4. 다양한 데이터베이스 포맷 지원 확장 (현재는 SQLite만 지원)
5. GUI 인터페이스 추가 고려

---

# iflist04.py 개발 내용

## 프로그램 개요
iflist04.py는 iflist03.py에서 생성한 엑셀 파일을 기반으로 기본행과 매칭행을 비교하고 검증하는 프로그램입니다. 주요 기능은 다양한 비교 규칙에 따라 컬럼 데이터를 검증하고, 오류가 있는 경우 '비교로그' 컬럼에 기록하는 것입니다.

## 주요 기능

### 1. 기본행과 매칭행 비교 검증
- iflist03.py에서 생성된 엑셀 파일은 기본행과 그 아래 연두색 매칭행이 쌍을 이루는 구조
- 첫 행은 컬럼명이며, 데이터는 두 번째 행부터 시작
- 기본행과 매칭행이 특정 규칙에 맞게 비교되는지 검증

### 2. 다양한 비교 규칙 적용
- 15가지 비교 규칙에 따라 컬럼별 검증 수행:
  1. 송신시스템 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  2. 수신시스템 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  3. I/F명 비교: 문자열 일치 확인
  4. Event_ID 비교: 특정 패턴(LY/LZ 접두어) 확인 후 변환 일치 검증
  5. 수신업무명 비교: 특정 변환 규칙(PNL_LY→MES_LH 등) 확인
  6. 송신업무명 비교: 특정 변환 규칙(PNL_LY→MES_LH 등) 확인
  7. 송신패키지 비교: 'LY'/'LZ' 포함 여부에 따른 'LH'/'VO' 포함 확인
  8. 수신패키지 비교: 'LY'/'LZ' 포함 여부에 따른 'LH'/'VO' 포함 확인
  9. EMS명 비교: 문자열 일치 확인
  10. Source Table 비교: '_', '.' 분할 후 LY/LZ 패턴 확인 및 변환 일치 검증
  11. Destination Table 비교: '_', '.' 분할 후 LY/LZ 패턴 확인 및 변환 일치 검증
  12. Routing 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  13. 스케쥴 비교: 문자열 일치 확인
  14. 주기구분 비교: 문자열 일치 확인
  15. 주기 비교: 문자열 일치 확인

### 3. 비교 결과 기록 및 표시
- 각 비교 항목의 오류를 '비교로그' 컬럼에 기록
- 오류가 없으면 'OK', 오류가 있으면 해당 오류 메시지 표시
- 오류가 있는 셀은 주황색 배경으로 강조 표시

### 4. 결과 파일 생성
- 검증 결과를 원본 파일명에 '_검증결과' 접미사를 붙여 새 파일로 저장
- openpyxl을 사용하여 셀 서식(색상) 적용

## 기술적 특징

### 1. 비교 로직 모듈화
- `check_systems`: 송신/수신시스템 비교 로직
- `check_business_name`: 업무명 비교 로직
- `check_package`: 패키지 비교 로직
- `check_same_content`: 단순 내용 일치 비교 로직
- `check_table_or_routing`: 테이블/라우팅 비교 로직
- `check_table_with_split`: 단어 분할 후 LY/LZ 검증 로직

### 2. 안전한 데이터 처리
- 문자열 타입 확인 및 NaN 값 안전 처리
- 누락된 컬럼에 대한 예외 처리

### 3. 자동화 기능
- 명령행 인수로 파일 경로 지정 가능
- 자동으로 가장 최근 iflist03 엑셀 파일 탐색 기능

### 4. 스키마 파일 경로 기능 추가 (v8.1)
- 송신/수신 스키마 파일 경로('송신스키마파일명', '수신스키마파일명') 컬럼 추가
- 스키마 파일 경로 계산 규칙:
  - 기본 경로: `C:\BwProject\`
  - 1번/2번 디렉토리: 기존 파일 경로 생성 로직과 동일
  - 3번 디렉토리: "SharedResources\Schema\source" (고정값)
  - 4번 디렉토리: 송신/수신 DB Name 컬럼 값
  - 5번 디렉토리: 송신/수신 Schema 컬럼 값
  - 파일명: Source Table 값을 '.'으로 분할한 두 번째 부분 + '.xsd'

### v8.2: 스키마 파일 존재 여부 확인 기능
- 스키마 파일 존재 여부를 새 컬럼('송신스키마파일존재', '수신스키마파일존재')에 저장
- Excel 출력 시 존재 여부에 따라 셀 색상 적용:
  - 파일이 존재하면 1(연두색)
  - 파일이 존재하지 않으면 0(주황색)
- 스키마 파일 존재 여부에 대한 통계 정보 출력

## 향후 개선 방향
1. 설정 파일을 통한 경로 및 규칙 관리
2. 명령행 옵션 추가 (디버그 모드, 출력 파일 지정 등)
3. GUI 인터페이스 개발 검토
4. 다양한 데이터베이스 지원 확장
5. 성능 최적화 (대용량 데이터 처리)

---

# iflist03a.py 개선사항

## 프로그램 개요
iflist03a.py는 iflist03.py와 iflist04.py의 기능을 통합한 파일입니다. 이 프로그램은 SQLite 데이터베이스에서 인터페이스 목록을 추출하여 Excel로 출력하고, 기본행과 매칭행을 비교 검증합니다.

## 버전 변경 내역

### v8.0: 기본 통합 버전
- iflist03.py와 iflist04.py의 기능을 하나의 파일로 통합
- 데이터베이스 데이터 추출, 패턴 매칭, 파일 경로 계산 기능 포함
- 기본행과 매칭행 간 15가지 규칙에 따른 비교 검증 기능 추가

### v8.1: 스키마 파일 경로 추가
- 송신/수신 스키마 파일 경로 컬럼 추가:
  - '송신SF'/'수신SF' → '송신스키마파일명'/'수신스키마파일명'으로 변경

### v8.2: 스키마 파일 존재 여부 확인
- 스키마 파일 존재 여부를 확인하는 기능 추가
- '송신스키마파일존재'/'수신스키마파일존재' 컬럼 추가
- 존재 여부에 따라 색상 코딩 적용 (존재: 연두색, 미존재: 주황색)

### v8.3: 불필요한 컬럼 필터링 기능
- "Unnamed: XX" 형식의 컬럼 중 XX가 10 이상인 컬럼을 Excel 출력 시 제외하는 기능 추가
- 이를 통해 Excel 출력물의 가독성 향상 및 불필요한 컬럼 제거
- 다음과 같은 조건으로 컬럼 필터링:
  1. 컬럼명이 "Unnamed:"로 시작
  2. ":" 이후 숫자가 10 이상인 경우
  3. 필터링된 컬럼만 유지하여 최종 Excel 파일에 저장

## 주요 기능 요약
1. SQLite DB에서 'LY'/'LZ' 패턴 포함 데이터 추출
2. 패턴 매칭 및 우선순위에 따른 행 재정렬
3. 송신/수신 파일 경로 및 스키마 파일 경로 계산
4. 파일 및 스키마 파일 존재 여부 확인
5. 디렉토리별 파일 개수 계산
6. 기본행과 매칭행 간 15가지 규칙 비교 검증
7. 결과를 색상 코딩이 적용된 Excel 파일로 출력
8. 불필요한 "Unnamed:" 컬럼 필터링

## 향후 개선 계획
1. 설정 파일을 통한 파일 경로 및 규칙 관리
2. 명령행 옵션 추가 (디버그 모드, 출력 파일 지정 등)
3. 성능 최적화 및 대용량 데이터 처리 개선
4. 사용자 인터페이스 개발 검토

---

# 문자열 치환 도구 작업 내용 정리

## 1. 스키마 파일 치환 규칙 수정
### 1.1 xmlns와 targetNamespace 치환 규칙 개선
- xmlns 속성 치환 패턴 수정
  - 기존: `<xs:schema[^>]*xmlns\s*=\s*"[^"]*{base_name}[^"]*"`
  - 변경: `xmlns\s*=\s*"[^"]*{base_name}[^"]*"`
  - 교체값도 태그 제외하고 속성만 포함하도록 수정

- targetNamespace 속성 치환 규칙 추가
  - 패턴: `targetNamespace\s*=\s*"[^"]*{base_name}[^"]*"`
  - 교체값: `targetNamespace="{namespace}"`

## 2. 프로세스 파일 치환 규칙 수정
### 2.1 activity name 태그 치환 패턴 개선
- 송신업무명 activity name 태그 치환
  - 기존: `<pd:activity\s+name="Check {re.escape(match_row["송신\n업무명"])}(?:[_0-9A-Za-z]*)"\\s*/?>`
  - 변경: `(<pd:activity\s+name="Check {match_row["송신\n업무명"]})`
  - 교체값에서 닫는 따옴표 제거

- 수신업무명 activity name 태그 치환
  - 기존: `<pd:activity\s+name="Check {re.escape(match_row["수신\n업무명"])}(?:[_0-9A-Za-z]*)"\\s*/?>`
  - 변경: `(<pd:activity\s+name="Check {match_row["수신\n업무명"]})`
  - 교체값에서 닫는 따옴표 제거

### 2.2 고정 문자열 치환 규칙 추가
기존 규칙:
```python
{
    "설명": "LHMES_MGR 치환",
    "찾기": {"정규식": "LHMES_MGR"},
    "교체": {"값": "LYMES_MGR"}
},
{
    "설명": "VOMES_MGR 치환",
    "찾기": {"정규식": "VOMES_MGR"},
    "교체": {"값": "LZMES_MGR"}
},
{
    "설명": "LH 문자열 치환",
    "찾기": {"정규식": "'LH'"},
    "교체": {"값": "'LY'"}
},
{
    "설명": "VO 문자열 치환",
    "찾기": {"정규식": "'VO'"},
    "교체": {"값": "'LZ'"}
}
```

추가된 규칙:
```python
{
    "설명": "LH 따옴표 문자열 치환",
    "찾기": {"정규식": "&quot;LH&quot;"},
    "교체": {"값": "&quot;LY&quot;"}
},
{
    "설명": "VO 따옴표 문자열 치환",
    "찾기": {"정규식": "&quot;VO&quot;"},
    "교체": {"값": "&quot;LZ&quot;"}
}
```

## 다음 작업 예정
- 추가적인 치환 규칙이 필요한 경우 계속해서 업데이트
- 치환 규칙의 정확성 검증
- 예외 케이스 처리 보완

# 작업 진행 상황 및 업데이트 내용

## 2024-03-XX 업데이트

### 1. 엑셀 로그 파일 개선
- 엑셀 파일 스타일링 적용
  - 폰트 크기 10으로 통일
  - 컬럼 너비 자동 조절
  - 생성여부(O/X) 컬럼 가운데 정렬
  - 헤더(첫 행) 연한 하늘색 배경 적용

### 2. 삭제 배치 파일 기능 추가
- 생성된 파일들을 일괄 삭제하는 배치 파일(.bat) 자동 생성
- 배치 파일 특징:
  - 로그 파일과 동일한 이름으로 '_delete.bat' 확장자 추가
  - 실제 존재하는 파일만 삭제 대상에 포함
  - 한글 깨짐 방지를 위한 코드 페이지(949) 설정
  - 삭제 대상 파일 목록을 주석으로 포함
  - 각 파일 삭제 시 진행 상황 표시
  - 삭제 실패 시 경고 메시지 출력

### 3. 로그 파일 구조
1. 텍스트 로그 파일 (.txt)
   - 기존 형식 유지
   - 작업 시간과 함께 상세 내역 기록

2. 엑셀 로그 파일 (.xlsx)
   - 컬럼 구조:
     - 파일타입 (송신파일경로, 수신파일경로, 송신스키마파일명, 수신스키마파일명)
     - 원본파일경로
     - 복사파일경로
     - 생성여부 (O/X)

3. 삭제 배치 파일 (_delete.bat)
   - 구조:
     ```batch
     @echo off
     chcp 949
     cls
     rem ===================================================================
     rem 삭제 대상 파일 목록
     rem ===================================================================
     rem [파일타입] 파일경로
     ...
     rem 총 삭제 대상 파일 수: X개
     rem ===================================================================

     echo 파일 삭제를 시작합니다...
     echo 총 X개의 파일을 삭제합니다.
     ...
     ```

### 4. 검증 포인트
- 엑셀 파일의 복사파일경로 수와 배치 파일의 삭제 대상 파일 수가 일치해야 함
- 배치 파일 상단의 주석을 통해 삭제 대상 파일 목록 확인 가능
- 실제 존재하는 파일만 삭제 대상에 포함됨

### 5. 다음 작업 예정
- 추가 기능 요청 시 구현 예정
- 버그 발견 시 수정 예정

## test_iflist.py

### 개요
인터페이스 정보 엑셀 파일과 TIBCO BW .process 파일, XSD 스키마 파일 간의 컬럼 매핑 일관성을 검증하는 모듈입니다. 엑셀에서 정의된 송신/수신 컬럼과 실제 BW 프로세스 파일의 컬럼 매핑, 그리고 스키마 파일의 구조가 일치하는지 5가지 관점에서 종합적으로 분석합니다.

### 주요 클래스 및 기능

#### 1. InterfaceExcelReader 클래스
엑셀 파일에서 인터페이스 정보를 읽어와 .process 파일과 스키마 파일과의 비교 분석을 수행하는 핵심 클래스입니다.

**주요 메서드:**
- `load_interfaces()`: 엑셀에서 인터페이스 정보 로드
- `compare_column_mappings()`: .process 파일과의 컬럼 매핑 비교 (3단계)
- `compare_schema_mappings()`: 스키마 파일과의 컬럼 비교 (2단계)
- `export_all_interfaces_to_log()`: 전체 분석 결과를 로그 파일로 출력

**엑셀 파일 구조:**
- B열부터 3컬럼 단위로 하나의 인터페이스 블록
- 1행: 인터페이스명, 일련번호 (C열)
- 2행: 인터페이스ID
- 3행: DB 연결 정보 (딕셔너리 형태)
- 4행부터: 송신/수신 컬럼 매핑 정보

#### 2. BWProcessFileParser 클래스
TIBCO BW .process 파일과 XSD 스키마 파일을 파싱하여 컬럼 정보를 추출하는 클래스입니다.

**주요 메서드:**
- `extract_column_mappings()`: 수신 .process 파일에서 INSERT 쿼리 및 컬럼 매핑 추출
- `extract_send_column_mappings()`: 송신 .process 파일에서 SELECT 쿼리 컬럼 추출
- `extract_schema_columns()`: XSD 스키마 파일에서 xs:element 컬럼 추출

**처리하는 파일 타입:**
- `.process`: TIBCO BW 프로세스 파일 (XML 구조)
- `.xsd`: XML 스키마 파일

#### 3. ProcessFileMapper 클래스
일련번호를 기준으로 인터페이스 정보와 실제 .process/.xsd 파일들을 연결하는 매핑 클래스입니다.

### 5가지 컬럼 매핑 비교 분석

#### 1. 엑셀 송신 컬럼 vs .process SELECT 컬럼 비교

**목적:** 엑셀에 정의된 송신 컬럼과 실제 송신 .process 파일의 SELECT 쿼리 컬럼이 일치하는지 검증

**비교 대상:**
- **엑셀 송신 컬럼**: 인터페이스 정의서의 송신측 컬럼 리스트
- **Process SELECT 컬럼**: SelectP 액티비티의 SELECT 쿼리에서 추출한 컬럼들

**기술적 구현:**
- `_compare_send_mapping()` 메서드에서 처리
- `extract_send_column_mappings()`로 SELECT 쿼리 파싱
- Oracle 힌트 제거 및 복잡한 함수 표현식 처리
- `TO_CHAR(CREATION_DATE, 'YYYYMMDDHH24MISS') CREATION_DATE` → `CREATION_DATE` 추출

**SELECT 쿼리 파싱 개선사항:**
- `_smart_column_split()`: 괄호와 따옴표를 고려한 정교한 컬럼 분리
- `_extract_column_name()`: 6단계 컬럼명 추출 로직
  1. AS 키워드 별칭 추출
  2. 공백 구분 별칭 확인
  3. 단순 함수 패턴 처리
  4. 복잡 함수 첫 번째 인자 추출
  5. 일반 컬럼명 처리
  6. 최후 수단 첫 번째 단어 추출

**출력 정보:**
- 매칭률, 테이블명, WHERE 조건, ORDER BY 절
- 매칭된 컬럼, 엑셀에만 있는 컬럼, Process에만 있는 컬럼

#### 2. 엑셀 수신 컬럼 vs .process INSERT 컬럼 비교

**목적:** 엑셀에 정의된 수신 컬럼과 실제 수신 .process 파일의 INSERT 쿼리 컬럼이 일치하는지 검증

**비교 대상:**
- **엑셀 수신 컬럼**: 인터페이스 정의서의 수신측 컬럼 리스트
- **Process INSERT 컬럼**: InsertAll 액티비티의 INSERT 쿼리에서 추출한 수신 컬럼들

**기술적 구현:**
- `_compare_single_mapping()` 메서드에서 처리
- INSERT 쿼리와 XML 매핑 구조 동시 분석
- `<pd:inputBindings>` → `<jdbcUpdateActivityInput>` → `<xsl:for-each>` → `<Record>` 경로 파싱

**값 타입 분류:**
- `direct`: `?` (직접 매핑)
- `function`: `TRIM(?)`, `UPPER(?)` 등 (함수 적용)
- `literal`: `'N'`, `'Y'` 등 (하드코딩 값)
- `conditional`: `<xsl:choose>` 등 (조건부)

**출력 정보:**
- 매칭된 컬럼과 해당 송신 컬럼 매핑 정보
- 값 타입 및 패턴 정보

#### 3. 송신-수신 연결 비교

**목적:** 송신 .process의 SELECT 컬럼과 수신 .process의 매핑된 송신 컬럼이 일치하는지 검증하여 데이터 흐름의 연속성 확인

**비교 대상:**
- **송신 SELECT 컬럼**: 송신 .process 파일의 SELECT 쿼리 컬럼들
- **수신 매핑 송신 컬럼**: 수신 .process 파일에서 `<xsl:value-of select="SEND_COL1"/>`로 매핑된 송신 컬럼들

**기술적 구현:**
- `_compare_send_recv_connection()` 메서드에서 처리
- 수신 .process에서 literal, pattern, conditional 값 제외
- 실제 송신 컬럼만 추출하여 비교

**검증 의미:**
- 송신에서 추출한 데이터가 수신에서 올바르게 매핑되는지 확인
- 데이터 흐름의 무결성 검증

#### 4. 송신 스키마 vs Process 송신 컬럼 비교

**목적:** 송신 스키마 파일(.xsd)에 정의된 구조와 실제 수신 .process에서 매핑하는 송신 컬럼이 일치하는지 검증

**비교 대상:**
- **송신 스키마 컬럼**: `<xs:element name="SEND_COL1"` 패턴의 name 속성들
- **Process 송신 컬럼**: 수신 .process에서 추출한 실제 송신 컬럼들

**기술적 구현:**
- `extract_schema_columns()`: XSD 파일에서 xs:element 추출
- 다양한 네임스페이스 처리 (`xs:`, 접두사 없음, local-name)
- 파일 없음 시 graceful skip 처리

**검증 의미:**
- 스키마 정의와 실제 프로세스 구현의 일관성 확인
- 송신측 데이터 구조의 표준 준수 여부 검증

#### 5. 수신 스키마 vs Process 송신 컬럼 비교

**목적:** 수신 스키마 파일(.xsd)에 정의된 구조와 실제 데이터 흐름이 일치하는지 검증

**비교 대상:**
- **수신 스키마 컬럼**: 수신측 XSD 파일의 xs:element name 속성들
- **Process 송신 컬럼**: 수신 .process에서 추출한 실제 송신 컬럼들

**검증 의미:**
- 수신측에서 기대하는 데이터 구조와 실제 수신하는 데이터의 일치성 확인
- 스키마는 송신쪽 테이블 정보를 따라가므로 송신 컬럼과 비교

### 로그 출력 기능

#### 전체 인터페이스 분석 로그 (`test_iflist.log`)

**포함 정보:**
```
=== 인터페이스 정보 분석 결과 로그 ===
생성일시: 2024-XX-XX XX:XX:XX
총 인터페이스 수: X개

[001] =========================== 인터페이스 정보 ===========================
인터페이스명: XXX
인터페이스ID: XXX
일련번호: XXX
송신/수신 테이블: XXX
파일 경로들: 원본/복사/스키마 파일들

--- 송신 컬럼 목록 (XX개) ---
--- 수신 컬럼 목록 (XX개) ---

--- 컬럼 매핑 비교 결과 ---
📤 송신 파일 비교 (매칭률, 테이블 정보, WHERE 조건)
📥 수신 파일 비교 (매칭률, 값 타입별 매핑)
🔗 송신-수신 연결 비교 (연결률, 데이터 흐름)

--- 스키마 파일 비교 결과 ---
📋 송신 스키마 비교 (구조 일관성)
📋 수신 스키마 비교 (데이터 흐름 일치성)
```

### 파일 구조 및 의존성

**입력 파일:**
- `iflist_in.xlsx`: 인터페이스 정보 엑셀 (B열부터 3컬럼 단위)
- `iflist03a_reordered_v8.3.xlsx`: ProcessFileMapper용 파일 (원본/복사파일 정보)
- 송신 `.process`: SelectP 액티비티에 SELECT 쿼리 포함
- 수신 `.process`: InsertAll 액티비티에 INSERT 쿼리 및 컬럼 매핑 포함
- 송신/수신 `.xsd`: XML 스키마 파일 (xs:element name 속성에 컬럼명 포함)

**출력 파일:**
- `test_iflist.log`: 전체 분석 결과 상세 로그
- `test_iflist_result.xlsx`: 비교 결과 요약 엑셀 (신규 추가)

### 사용법

```python
# 1. 기본 사용법
reader = InterfaceExcelReader()
interfaces = reader.load_interfaces('iflist_in.xlsx')

# 2. 개별 인터페이스 분석
for interface in interfaces:
    # .process 파일 비교 (3단계)
    comparison_result = reader.compare_column_mappings(interface)
    
    # 스키마 파일 비교 (2단계)
    schema_comparison = reader.compare_schema_mappings(interface)

# 3. 전체 결과 로그 출력
reader.export_all_interfaces_to_log(interfaces)

# 4. 개별 파일 직접 분석
bw_parser = BWProcessFileParser()

# SELECT 쿼리 컬럼 추출
send_columns = bw_parser.extract_send_column_mappings('send.process')

# INSERT 쿼리 매핑 추출  
recv_mappings = bw_parser.extract_column_mappings('recv.process')

# 스키마 컬럼 추출
schema_columns = bw_parser.extract_schema_columns('schema.xsd')
```

### 주요 개선사항

#### 디버깅 및 오류 처리
- 상세한 로그 메시지 및 진행 상황 출력
- 파일 없음, XML 파싱 오류 등 예외 상황 graceful 처리
- 각 처리 단계별 오류 메시지 수집 및 보고

#### SQL 파싱 고도화
- Oracle 힌트 자동 제거
- 복잡한 함수 표현식 정확한 파싱 (`TO_CHAR`, `TRIM`, `UPPER` 등)
- 괄호와 따옴표를 고려한 스마트 컬럼 분리
- AS 별칭 및 공백 별칭 정확한 처리

#### XML 파싱 견고성
- 다양한 네임스페이스 자동 처리
- XPath 패턴 fallback 메커니즘
- BW .process 파일의 복잡한 XML 구조 정확한 파싱

#### 테스트 환경 지원
- 경로 변환 로직 (`C:\BwProject\` → `C:\tBwProject\`)
- 디버깅 모드 지원 (첫 번째 인터페이스만 처리)
- 상세한 비교 결과 및 통계 정보 제공

### 분석 결과의 의미

이 5가지 비교를 통해 다음을 검증할 수 있습니다:

1. **설계 일관성**: 엑셀 정의서와 실제 구현의 일치
2. **데이터 흐름 무결성**: 송신에서 수신까지의 연속성
3. **스키마 준수**: 정의된 구조와 실제 데이터의 일치
4. **구현 정확성**: BW 프로세스의 올바른 구현
5. **유지보수성**: 변경 사항 추적 및 영향도 분석

전체적으로 인터페이스의 설계부터 구현, 데이터 흐름까지의 완전한 일관성을 보장하는 종합적인 검증 도구입니다.

### 최근 개선사항 (2024)

#### 1. 송신-수신 연결 비교 로직 완전 개선

**문제점:** 기존 3번째 비교가 송신 .process SELECT 컬럼 vs 수신 .process 매핑 송신 컬럼을 비교하고 있었음

**해결책:** 엑셀 송신-수신 매핑 쌍 vs .process 송신-수신 매핑 쌍의 포함율 비교로 변경

**기술적 구현:**
- `_compare_send_recv_connection()` 메서드 완전 재작성
- 엑셀 데이터에서 순서대로 송신-수신 쌍 생성 (1:1 인덱스 매핑)
- Process에서 `<xsl:value-of select="SEND_COL"/>` 패턴으로 송신-수신 쌍 추출
- 포함율 계산: 엑셀 쌍이 Process 쌍에 얼마나 포함되는지 백분율로 표시

**개선 효과:**
- 엑셀 정의와 실제 프로세스 구현의 매핑 일관성 정확한 검증
- 데이터 흐름의 연속성 검증 가능

#### 2. 엑셀 요약 출력 기능 추가

**신규 기능:** `export_summary_to_excel()` 메서드 추가

**출력 컬럼 구조:**
```
일련번호, 인터페이스명, 인터페이스ID, 송신DB, 수신DB, 송신테이블, 수신테이블,
송신비교_매칭률, 송신비교_결과요약,
수신비교_매칭률, 수신비교_결과요약,
연결비교_매칭률, 연결비교_결과요약,
송신스키마_매칭률, 송신스키마_결과요약,
수신스키마_매칭률, 수신스키마_결과요약
```

**색상 코딩 시스템:**
- **주황색 (`FFA500`)**: 매칭률 < 100%인 경우
- **연한 회색 (`D3D3D3`)**: "비교 미수행" 또는 오류 발생시
- 자동 컬럼 너비 조절 및 가운데 정렬 적용

**결과 요약 로직:**
- `_generate_comparison_summary()` 메서드로 각 비교 타입별 요약
- "완전일치", "불일치 X개", "데이터 없음", "오류: 파일 없음" 등의 명확한 상태 표시

#### 3. 연결 비교 독립성 확보

**문제점:** 연결 비교가 개별 송신/수신 파일 존재에 의존하여 "오류: 파일 없음"으로 실패

**해결책:** 연결 비교를 엑셀 데이터만으로 수행 가능하도록 독립적으로 개선

**기술적 구현:**
- 엑셀 송신-수신 컬럼에서 직접 매핑 쌍 생성
- 수신 .process 파일이 있을 때만 Process 쌍과 비교
- 수신 파일이 없어도 엑셀 쌍 정보는 표시
- `_generate_comparison_summary()`에서 연결 타입 특별 처리

**개선 효과:**
- 파일 의존성 없이도 엑셀 데이터 기반 분석 가능
- 더 안정적이고 유연한 비교 시스템

#### 4. 공백 처리 개선

**문제점:** 엑셀 컬럼에 trailing space가 있어 비교 실패

**해결책:** 포괄적 공백 제거 로직 적용

**기술적 구현:**
- `_read_column_mappings()`에서 엑셀 셀 값 읽기 시 `.strip()` 적용
- 모든 비교 메서드에서 일관된 `.strip()` 처리
- 리스트 생성, 개별 비교, 결과 저장 모든 단계에서 공백 제거

**처리 위치:**
```python
# 엑셀 읽기 시
send_columns.append(str(send_value).strip() if send_value else '')

# 비교 시  
excel_col_lower = excel_col.strip().lower()

# 결과 저장 시
matches.append({'excel_column': excel_col.strip(), ...})
```

#### 5. VALUES 패턴 처리 개선

**문제점:** `TO_DATE(?, 'YYYY-MM-DD HH24:MI:SS')`같은 함수가 콤마로 잘못 분리되어 처리

**해결책:** 스마트 패턴 분리 및 함수 감지 로직 구현

**기술적 구현:**

1. **스마트 분리:** `_smart_column_split()` 적용
   - 괄호 안의 콤마는 분리하지 않음
   - 따옴표 안의 콤마도 보호

2. **함수 패턴 감지:** `_is_function_pattern()` 메서드 추가
   ```python
   sql_functions = [
       'TO_DATE(', 'TO_CHAR(', 'TO_NUMBER(',
       'TRIM(', 'LTRIM(', 'RTRIM(',
       'UPPER(', 'LOWER(', 'INITCAP(',
       'SUBSTR(', 'SUBSTRING(',
       'NVL(', 'NVL2(', 'COALESCE(',
       'DECODE(', 'CASE ',
       'LENGTH(', 'INSTR(',
       'REPLACE(', 'TRANSLATE(',
       'SYSDATE', 'SYSTIMESTAMP'
   ]
   ```

3. **함수 단순화:** 복잡한 함수를 `?`로 단순화
   ```
   TO_DATE(?, 'YYYY-MM-DD HH24:MI:SS') → ?
   TRIM(?) → ?
   'N' → 'N' (리터럴은 유지)
   ```

**처리 결과:**
```
VALUES 패턴들 (원본): ['TO_DATE(?, 'YYYY-MM-DD HH24:MI:SS')', 'TRIM(?)', "'N'"]
함수 패턴 감지하여 '?'로 변환: TO_DATE(?, 'YYYY-MM-DD HH24:MI:SS') -> ?
함수 패턴 감지하여 '?'로 변환: TRIM(?) -> ?
VALUES 패턴들 (처리후): ['?', '?', "'N'"]
```

### 향후 개발 계획

1. **성능 최적화**: 대용량 인터페이스 처리를 위한 메모리 및 속도 개선
2. **GUI 인터페이스**: 사용자 친화적인 분석 도구 개발
3. **설정 관리**: 파일 경로 및 비교 규칙의 외부 설정 파일 관리
4. **리포트 기능**: 더 상세한 분석 리포트 및 차트 생성
5. **자동화**: CI/CD 파이프라인과의 통합 고려

### 기술적 특징 요약

- **모듈식 설계**: 각 비교 기능이 독립적으로 동작
- **안전한 파싱**: XML, XSD, Excel 파일의 robust한 처리
- **유연한 매핑**: 다양한 매핑 패턴과 예외 상황 처리
- **풍부한 로깅**: 상세한 분석 과정과 결과 기록
- **사용자 친화**: 색상 코딩과 요약 정보로 직관적 결과 제공
