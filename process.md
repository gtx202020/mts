# iflist02.py 프로세스 분석

## 프로그램 개요
이 프로그램은 SQLite 데이터베이스에서 특정 조건에 맞는 데이터를 추출하여 가공한 후 Excel 파일로 출력하는 작업을 수행합니다. 주요 기능은 'LY'와 'LZ' 문자열이 포함된 행을 찾아 관련 데이터를 재정렬하고, 특정 조건에 맞는 행을 노란색으로 표시하는 것입니다.

## 처리 프로세스

### 1. 초기 설정
- SQLite DB 파일명 (info.sqlite)과 테이블명 (list) 설정
- 대상 컬럼명 설정: '컬럼B', '컬럼C', '컬럼D'
- 검색 및 대체 문자열 정의:
  - 'LY'를 'LH'로 대체
  - 'LZ'를 'VO'로 대체
- 출력 Excel 파일명 설정: 스크립트 이름 + "_reordered_v2.xlsx" (버전 표시)

### 2. 데이터베이스에서 데이터 추출
- SQLite 데이터베이스에 연결
- **원본 전체 데이터 로드**: 테이블의 모든 행을 df_complete_table로 로드
- **초기 필터링 적용**: 컬럼B 또는 컬럼C에 'LY' 또는 'LZ'가 포함된 행만 df_filtered로 추출
- 문자열 변환 및 NaN 처리를 통한 안전한 필터링 로직 적용

### 3. 데이터 가공 및 재정렬
- 필수 컬럼 존재 여부 확인 (df_filtered와 df_complete_table 모두에서 확인)
- df_filtered의 각 행에 대해 다음 처리 수행:
  1. 원본 행을 output_rows_info 리스트에 추가 (노란색 표시 없음)
  2. 현재 행의 컬럼D 값과 동일한 값을 가진 다른 행들을 **원본 전체 테이블(df_complete_table)에서** 검색
  3. 추가 필터링 조건 적용:
     - 컬럼B에서 'LY'를 'LH'로 또는 'LZ'를 'VO'로 변환했을 때 다른 행의 컬럼B와 일치하는지 확인
     - 컬럼C에서 'LY'를 'LH'로 또는 'LZ'를 'VO'로 변환했을 때 다른 행의 컬럼C와 일치하는지 확인
  4. 조건을 만족하는 행을 output_rows_info에 추가하고 노란색 표시 플래그 설정

### 4. 최종 DataFrame 생성
- output_rows_info의 데이터를 기반으로 최종 DataFrame(df_excel_output) 생성
- 컬럼 순서 유지를 위해 원본 테이블의 컬럼 정보 활용
- 노란색으로 표시할 행의 인덱스 리스트 생성

### 5. Excel 파일 생성 및 스타일 적용
- xlsxwriter 엔진을 사용하여 Excel 파일 생성
- 'ProcessedData' 시트에 데이터 저장
- 조건에 맞는 행에 노란색 배경 적용
- 컬럼 너비 자동 조절 (가독성 향상)
- 결과 파일 저장

## 주요 조건 및 로직
1. **초기 필터링**: 컬럼B 또는 컬럼C에 'LY' 또는 'LZ'가 포함된 행 추출
2. **행 매칭 조건**:
   - 컬럼D 값이 동일(공백 제거 후)
   - 컬럼B에서 'LY'→'LH' 또는 'LZ'→'VO' 변환 후 일치
   - 또는 컬럼C에서 'LY'→'LH' 또는 'LZ'→'VO' 변환 후 일치
3. **출력 형식**: 원본 행 뒤에 매칭된 행을 배치하고, 매칭된 행은 노란색으로 표시

## 개선된 기능
1. **전체 데이터 활용**: 원본 전체 테이블(df_complete_table)을 로드하여 더 많은 데이터와 비교 가능
2. **안전한 데이터 처리**: 
   - 데이터프레임 복사본 생성으로 원본 데이터 보존
   - 문자열 변환 및 NaN 처리를 통한 안전한 필터링
3. **컬럼 순서 유지**: 원본 테이블의 컬럼 순서를 최종 결과물에도 적용
4. **상세한 오류 메시지**: 다양한 상황에 대한 구체적인 오류 메시지 제공

## 예외 처리
- 데이터베이스 연결 오류 처리
- 원본 테이블 데이터 없음 처리
- 필터링 결과 없음 처리
- 필수 컬럼 존재 여부 확인 (df_filtered와 df_complete_table 모두)
- Excel 파일 저장 시 예외 처리
- 필요 라이브러리(xlsxwriter) 미설치 시 안내 메시지 출력

---

# iflist03.py 개선사항 요약

## 버전 변경 내역

### v3.0: 다중 매칭 시 우선순위 적용 및 디버깅용 색상 구분
- 여러 매칭 행이 있을 때 우선순위 필터링 기능 추가:
  - 케이스 1: 송신시스템과 수신시스템 모두 매칭되는 행
  - 케이스 2: 송신시스템 값이 같은 행
  - 케이스 2-1: 수신시스템 값이 같은 행
- 가시성 향상을 위해 행 색상 구분:
  - 매칭된 모든 행: 노란색
  - 우선순위로 필터링된 최종 행: 연두색

### v4.0: 디버깅 모드 토글 기능
- `debug_mode` 변수 추가로 출력 제어:
  - `debug_mode = 0` 또는 `2`: 최종 필터링된 행(연두색)만 표시
  - `debug_mode = 1`: 모든 매칭 행(노란색)과 필터링된 행(연두색) 모두 표시
- 출력 메시지를 디버그 모드에 따라 다르게 설정

### v5.0: 송신/수신 파일 경로 정보 컬럼 추가
- 각 행에 송신 및 수신 파일 경로 정보를 계산하여 추가 컬럼으로 저장
- 파일 경로 생성 규칙 구현:
  - 기본 경로: `C:\BwProject\`
  - 디렉토리 구조: `1번 디렉토리\2번 디렉토리\Processes\3번 디렉토리\4번 디렉토리\5번디렉토리\파일명`
  - 법인 정보에 따른 1번 디렉토리 결정 (KR, CN, VN 및 TEST/PROD 접미사)
  - 패키지 이름 기반의 2번/5번 디렉토리
  - 업무명에 따른 조건부 3번 디렉토리
  - EMS명에 따른 4번 디렉토리
  - 그룹ID, 이벤트ID 등을 활용한 파일명 생성

### v6.0: 파일 존재 여부 확인 기능
- 생성된 파일 경로가 실제로 존재하는지 확인하는 기능 추가
- 파일 존재 여부를 새 컬럼('송신파일존재', '수신파일존재')에 저장
- Excel 출력 시 존재 여부에 따라 셀 색상 적용:
  - 파일이 존재하면 1(연두색)
  - 파일이 존재하지 않으면 0(주황색)

### v7.0: 디렉토리 파일 개수 확인 기능
- 파일이 위치한 디렉토리의 파일 개수를 세는 기능 추가
- 파일이 존재할 경우에만 디렉토리 파일 개수 계산
- 결과를 새 컬럼('송신DF', '수신DF')에 저장
- Excel 출력 시 파일 개수에 따라 차등 색상 적용:
  - 0개: 회색
  - 1-3개: 매우 밝은 파란색
  - 4-10개: 밝은 파란색
  - 11-20개: 중간 파란색
  - 21개 이상: 진한 파란색
- 디렉토리 파일 개수에 대한 통계 정보 출력 (총 파일 수, 디렉토리당 평균 파일 수)

## 구현된 주요 기능

### 디버그 모드 설정
```python
# 디버깅 모드 설정
# debug_mode = 0 또는 2: 최종 필터링된 행(연두색)만 표시
# debug_mode = 1: 모든 매칭 행(노란색)과 필터링된 행(연두색) 모두 표시
debug_mode = 1  # 기본값: 디버깅 모드 활성화
```

### 파일 경로 생성
```python
def create_file_path(row, is_send=True):
    # 행 데이터로부터 송신/수신 파일 경로 생성
    # 송신/수신 파라미터에 따라 다른 경로 계산
    # 컬럼값 누락 시 안전한 처리
    # ...
```

### 파일 존재 여부 확인
```python
def check_file_exists(file_path):
    # 파일 경로가 실제로 존재하는지 확인
    # 존재하면 1, 존재하지 않으면 0 반환
    # ...
```

### 디렉토리 파일 개수 계산
```python
def count_files_in_directory(file_path):
    # 파일이 위치한 디렉토리 내 파일 개수 반환
    # 디렉토리 내 파일만 카운트 (하위 디렉토리 제외)
    # ...
```

## 향후 고려사항
1. 파일 경로의 기본 경로(`C:\BwProject`)를 설정 파일이나 명령행 인수로 지정할 수 있는 기능 추가
2. 디렉토리 구조 및 파일명 생성 규칙을 더 유연하게 설정할 수 있도록 개선
3. 존재하지 않는 파일의 생성 기능 구현 (필요시)
4. 다양한 데이터베이스 포맷 지원 확장 (현재는 SQLite만 지원)
5. GUI 인터페이스 추가 고려

---

# iflist04.py 개발 내용

## 프로그램 개요
iflist04.py는 iflist03.py에서 생성한 엑셀 파일을 기반으로 기본행과 매칭행을 비교하고 검증하는 프로그램입니다. 주요 기능은 다양한 비교 규칙에 따라 컬럼 데이터를 검증하고, 오류가 있는 경우 '비교로그' 컬럼에 기록하는 것입니다.

## 주요 기능

### 1. 기본행과 매칭행 비교 검증
- iflist03.py에서 생성된 엑셀 파일은 기본행과 그 아래 연두색 매칭행이 쌍을 이루는 구조
- 첫 행은 컬럼명이며, 데이터는 두 번째 행부터 시작
- 기본행과 매칭행이 특정 규칙에 맞게 비교되는지 검증

### 2. 다양한 비교 규칙 적용
- 15가지 비교 규칙에 따라 컬럼별 검증 수행:
  1. 송신시스템 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  2. 수신시스템 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  3. I/F명 비교: 문자열 일치 확인
  4. Event_ID 비교: 특정 패턴(LY/LZ 접두어) 확인 후 변환 일치 검증
  5. 수신업무명 비교: 특정 변환 규칙(PNL_LY→MES_LH 등) 확인
  6. 송신업무명 비교: 특정 변환 규칙(PNL_LY→MES_LH 등) 확인
  7. 송신패키지 비교: 'LY'/'LZ' 포함 여부에 따른 'LH'/'VO' 포함 확인
  8. 수신패키지 비교: 'LY'/'LZ' 포함 여부에 따른 'LH'/'VO' 포함 확인
  9. EMS명 비교: 문자열 일치 확인
  10. Source Table 비교: '_', '.' 분할 후 LY/LZ 패턴 확인 및 변환 일치 검증
  11. Destination Table 비교: '_', '.' 분할 후 LY/LZ 패턴 확인 및 변환 일치 검증
  12. Routing 비교: 'LY'→'LH', 'LZ'→'VO' 변환 일치 확인
  13. 스케쥴 비교: 문자열 일치 확인
  14. 주기구분 비교: 문자열 일치 확인
  15. 주기 비교: 문자열 일치 확인

### 3. 비교 결과 기록 및 표시
- 각 비교 항목의 오류를 '비교로그' 컬럼에 기록
- 오류가 없으면 'OK', 오류가 있으면 해당 오류 메시지 표시
- 오류가 있는 셀은 주황색 배경으로 강조 표시

### 4. 결과 파일 생성
- 검증 결과를 원본 파일명에 '_검증결과' 접미사를 붙여 새 파일로 저장
- openpyxl을 사용하여 셀 서식(색상) 적용

## 기술적 특징

### 1. 비교 로직 모듈화
- `check_systems`: 송신/수신시스템 비교 로직
- `check_business_name`: 업무명 비교 로직
- `check_package`: 패키지 비교 로직
- `check_same_content`: 단순 내용 일치 비교 로직
- `check_table_or_routing`: 테이블/라우팅 비교 로직
- `check_table_with_split`: 단어 분할 후 LY/LZ 검증 로직

### 2. 안전한 데이터 처리
- 문자열 타입 확인 및 NaN 값 안전 처리
- 누락된 컬럼에 대한 예외 처리

### 3. 자동화 기능
- 명령행 인수로 파일 경로 지정 가능
- 자동으로 가장 최근 iflist03 엑셀 파일 탐색 기능

### 4. 스키마 파일 경로 기능 추가 (v8.1)
- 송신/수신 스키마 파일 경로('송신SF', '수신SF') 컬럼 추가
- 스키마 파일 경로 계산 규칙:
  - 기본 경로: `C:\BwProject\`
  - 1번/2번 디렉토리: 기존 파일 경로 생성 로직과 동일
  - 3번 디렉토리: "SharedResources\Schema\source" (고정값)
  - 4번 디렉토리: 송신/수신 DB Name 컬럼 값
  - 5번 디렉토리: 송신/수신 Schema 컬럼 값
  - 파일명: Source Table 값을 '.'으로 분할한 두 번째 부분 + '.xsd'

## 향후 개선 방향
1. 설정 파일을 통한 경로 및 규칙 관리
2. 명령행 옵션 추가 (디버그 모드, 출력 파일 지정 등)
3. GUI 인터페이스 개발 검토
4. 다양한 데이터베이스 지원 확장
5. 성능 최적화 (대용량 데이터 처리)
